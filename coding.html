// AQICN API token
const aqicnApiToken = '14f1009d49801c70f85dbefe09b36abe9b35aef4';

// Function to toggle AQI layer
function toggleAirQualityLayer() {
    if (activeLayers['air-quality-layer']) {
        map.removeLayer('air-quality-layer');
        map.removeSource('air-quality');
        activeLayers['air-quality-layer'] = false;
    } else {
        fetchAndAddAirQualityLayer();
        activeLayers['air-quality-layer'] = true;
    }
}

// Fetch AQI data from AQICN and add it to the map
async function fetchAndAddAirQualityLayer() {
    try {
        const response = await fetch(`https://api.waqi.info/map/bounds/?token=${aqicnApiToken}&latlng=-85,-180,85,180`);
        const data = await response.json();

        // Transform AQICN data to GeoJSON format
        const airQualityGeoJSON = {
            type: "FeatureCollection",
            features: data.data.map(station => ({
                type: "Feature",
                geometry: {
                    type: "Point",
                    coordinates: [station.lon, station.lat]
                },
                properties: {
                    aqi: station.aqi
                }
            }))
        };

        // Add AQI data as a source on the map
        map.addSource('air-quality', {
            type: 'geojson',
            data: airQualityGeoJSON
        });

        // Add the layer with color-coded AQI levels
        map.addLayer({
            'id': 'air-quality-layer',
            'type': 'circle',
            'source': 'air-quality',
            'paint': {
                'circle-radius': 8,
                'circle-color': [
                    'interpolate',
                    ['linear'],
                    ['get', 'aqi'],
                    0, '#00e400',  // Good (Green)
                    50, '#ffff00', // Moderate (Yellow)
                    100, '#ff7e00', // Unhealthy for Sensitive Groups (Orange)
                    150, '#ff0000', // Unhealthy (Red)
                    200, '#99004c', // Very Unhealthy (Purple)
                    300, '#7e0023'  // Hazardous (Maroon)
                ],
                'circle-opacity': 0.8
            }
        });
    } catch (error) {
        console.error('Error fetching or adding AQI data:', error);
    }
}

// Add event listener for the AQI button
document.getElementById('airQuality').onclick = toggleAirQualityLayer;
